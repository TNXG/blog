<% if(theme.sw){ %>
<script>
  // 判断是否为主域名
  if (window.location.host.startsWith("blog.tnxg.top") || window.location.host.startsWith("localhost")) {
    // 如果有旧版本的CW，先卸载
    if (localStorage.getItem('cw_installed') == 'true') {
      console.log('[TNXG_SW]检测到旧版本的CW，正在卸载...');
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for (let registration of registrations) {
          registration.unregister()
        }
      })
    } else {
      if (!!navigator.serviceWorker) {
        navigator.serviceWorker.register('/sw.js?t=' + new Date().getTime()).then(async (registration) => {
          if (localStorage.getItem('TNXG_SW_installed') !== 'true') {
            localStorage.setItem('TNXG_SW_installed', 'true');
            console.log('[TNXG_SW] 安装成功，正在重载页面！');
            fetch(window.location.href).then(res => res.text()).then(text => {
              document.open()
              document.write(text);
              document.close();
            });
          }
        }).catch(err => {
          console.error('[TNXG_SW] 安装失败，原因： ' + err.message);
        });

      } else {
        console.error('[TNXG_SW] 安装失败，原因： 浏览器不支持service worker');
      }
    }
  } else {
    fetch('https://assets.tnxg.whitenuo.cn/data/blog_error.html')
      .then(res => res.text())
      .then(text => {
        document.open()
        document.write(text);
        document.close();
      });
  }
</script>
<% } %>